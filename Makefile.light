# ê²½ëŸ‰ ê°œë°œ í™˜ê²½ìš© Makefile
# 2GB RAM ì‹œìŠ¤í…œìš©

.PHONY: help
help: ## ë„ì›€ë§ í‘œì‹œ
	@echo "ğŸš€ RiskRadar ê²½ëŸ‰ ê°œë°œ í™˜ê²½ (2GB RAM)"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# ==================== ê¸°ë³¸ ëª…ë ¹ì–´ ====================

.PHONY: setup
setup: ## ì´ˆê¸° ì„¤ì •
	cp .env.example .env
	@echo "âœ… í™˜ê²½ ì„¤ì • ì™„ë£Œ"

.PHONY: clean
clean: ## ëª¨ë“  ì»¨í…Œì´ë„ˆ ì •ë¦¬
	docker-compose -f docker-compose.light.yml down -v
	docker system prune -f

# ==================== ê°œë³„ ì„œë¹„ìŠ¤ ì‹¤í–‰ ====================

.PHONY: redis
redis: ## Redisë§Œ ì‹¤í–‰
	docker-compose -f docker-compose.light.yml up -d redis
	@echo "âœ… Redis ì‹¤í–‰ë¨ (Port: 6379)"

.PHONY: data
data: redis ## Data Service ì‹¤í–‰
	docker-compose -f docker-compose.light.yml up data-service

.PHONY: ml
ml: redis ## ML Service ì‹¤í–‰
	docker-compose -f docker-compose.light.yml --profile ml up ml-service

.PHONY: graph
graph: redis ## Graph Service ì‹¤í–‰
	docker-compose -f docker-compose.light.yml --profile graph up graph-service

.PHONY: api
api: redis ## API Gateway ì‹¤í–‰
	docker-compose -f docker-compose.light.yml --profile api up api-gateway

.PHONY: ui
ui: ## Web UI ì‹¤í–‰ (ë¡œì»¬ ê°œë°œ ì„œë²„ ê¶Œì¥)
	docker-compose -f docker-compose.light.yml --profile ui up web-ui

# ==================== ë¡œì»¬ ê°œë°œ (Docker ì—†ì´) ====================

.PHONY: local-setup
local-setup: ## ë¡œì»¬ ê°œë°œ í™˜ê²½ ì„¤ì •
	@echo "ğŸ“¦ Python ê°€ìƒí™˜ê²½ ìƒì„±..."
	cd services/data-service && python3 -m venv venv || true
	cd services/ml-service && python3 -m venv venv || true
	cd services/graph-service && python3 -m venv venv || true
	@echo "ğŸ“¦ Node.js íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
	cd services/api-gateway && npm install || true
	cd services/web-ui && npm install || true

.PHONY: local-data
local-data: ## Data Service ë¡œì»¬ ì‹¤í–‰
	cd services/data-service && \
	. venv/bin/activate && \
	REDIS_URL=redis://localhost:6379 \
	USE_MOCK_KAFKA=true \
	python -m src.main

.PHONY: local-ml
local-ml: ## ML Service ë¡œì»¬ ì‹¤í–‰
	cd services/ml-service && \
	. venv/bin/activate && \
	REDIS_URL=redis://localhost:6379 \
	USE_MOCK_KAFKA=true \
	python -m src.main

.PHONY: local-api
local-api: ## API Gateway ë¡œì»¬ ì‹¤í–‰
	cd services/api-gateway && \
	USE_MOCK_SERVICES=true \
	npm run dev

.PHONY: local-ui
local-ui: ## Web UI ë¡œì»¬ ì‹¤í–‰
	cd services/web-ui && \
	npm run dev

# ==================== í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ====================

.PHONY: test-flow
test-flow: ## ê°„ë‹¨í•œ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
	@echo "1ï¸âƒ£ Redisì— Mock ë°ì´í„° ìƒì„±..."
	docker-compose -f docker-compose.light.yml exec redis redis-cli SET "mock:company:1" '{"name":"Samsung","riskScore":5.0}'
	@echo "2ï¸âƒ£ ë°ì´í„° í™•ì¸..."
	docker-compose -f docker-compose.light.yml exec redis redis-cli GET "mock:company:1"

.PHONY: status
status: ## ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
	@echo "ğŸ” ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
	@docker ps --filter "name=riskradar" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

.PHONY: logs
logs: ## ì „ì²´ ë¡œê·¸ ë³´ê¸°
	docker-compose -f docker-compose.light.yml logs -f

# ==================== ë©”ëª¨ë¦¬ ëª¨ë‹ˆí„°ë§ ====================

.PHONY: memory
memory: ## ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
	@echo "ğŸ’¾ ì‹œìŠ¤í…œ ë©”ëª¨ë¦¬:"
	@free -h
	@echo ""
	@echo "ğŸ³ Docker ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
	@docker stats --no-stream --format "table {{.Container}}\t{{.MemUsage}}\t{{.MemPerc}}"

# ==================== ê°œë°œ íŒ ====================

.PHONY: tips
tips: ## ê°œë°œ íŒ í‘œì‹œ
	@echo "ğŸ’¡ ê²½ëŸ‰ í™˜ê²½ ê°œë°œ íŒ:"
	@echo ""
	@echo "1. í•œë²ˆì— 1-2ê°œ ì„œë¹„ìŠ¤ë§Œ ì‹¤í–‰í•˜ì„¸ìš”"
	@echo "   make data  # Data Serviceë§Œ"
	@echo "   make api   # API Gatewayë§Œ"
	@echo ""
	@echo "2. ë¡œì»¬ ê°œë°œ ì¶”ì²œ (Docker ì—†ì´)"
	@echo "   make local-setup  # ì´ˆê¸° ì„¤ì •"
	@echo "   make local-ui     # UI ê°œë°œ"
	@echo ""
	@echo "3. ë©”ëª¨ë¦¬ ë¶€ì¡± ì‹œ"
	@echo "   make clean        # ì»¨í…Œì´ë„ˆ ì •ë¦¬"
	@echo "   make memory       # ì‚¬ìš©ëŸ‰ í™•ì¸"
	@echo ""
	@echo "4. ì‹¤ì œ Kafka/Neo4jê°€ í•„ìš”í•œ ê²½ìš°"
	@echo "   í´ë¼ìš°ë“œ ì„œë¹„ìŠ¤ ì‚¬ìš©ì„ ê³ ë ¤í•˜ì„¸ìš”"